# @TEST-DOC: Check external an internal sync of `&synchronized` vector fields.

# @TEST-EXEC: spicyc -j -d -o test.hlto %INPUT

# @_TEST-EXEC: ${SCRIPTS}/printf '\x00ABAB' | spicy-driver -d test.hlto >>output 2>&1

# External sync.
# @_TEST-EXEC: ${SCRIPTS}/printf 'ABAB' | spicy-driver -d test.hlto >>output 2>&1
# @_TEST-EXEC: ${SCRIPTS}/printf '1ABAB' | spicy-driver -d test.hlto >>output 2>&1

# Internal sync.
# @_TEST-EXEC: ${SCRIPTS}/printf '\x00\x01ABAB' | HILTI_DEBUG=spicy-verbose spicy-driver -d test.hlto >>output 2>&1
# @_TEST-EXEC: ${SCRIPTS}/printf '\x00\x01' | HILTI_DEBUG=spicy-verbose spicy-driver -d test.hlto >>output 2>&1
# @_TEST-EXEC: ${SCRIPTS}/printf '\x00AB_AB' | HILTI_DEBUG=spicy-verbose spicy-driver -d test.hlto >>output 2>&1
# @TEST-EXEC: ${SCRIPTS}/printf 'ABAAB' | HILTI_DEBUG=spicy-verbose spicy-driver -d test.hlto >>output 2>&1
# @_TEST-EXEC: ${SCRIPTS}/printf 'ABAAB____AB' | HILTI_DEBUG=spicy-verbose spicy-driver -d test.hlto >>output 2>&1

# @TEST-EXEC: btest-diff output

module test;

type X = unit {
    a: /A/;
    b: /B/;
} &convert="AB";

public type Y = unit {
    a: uint8(0);
    xs: X[] &synchronized foreach { print "Foreach: %s" % $$; }

    on %synced { print "Synced: %s" % self; self.confirm(); }
    on %confirmed { print "Confirmed: %s" % self; }
    on %rejected { print "Rejected: %s" % self; }
    on %done { print "Done: %s" % self; }
    on %error { print "Error: %s" % self; }
};
